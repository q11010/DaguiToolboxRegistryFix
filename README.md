# Dagui Toolbox Registry Fix

Fixes the lag caused Dagui Toolbox [Steam Workshop Link](https://steamcommunity.com/sharedfiles/filedetails/?id=2990736022) by removing Cached Pinyin PlayerPrefs generated when searching.

To use: Install the mod, load a save, manually save the game, and restart the game.

See official game modding guide on build instructions

Don't read further if you don't want to see me ranting.

## How the problem was found

Some reported that Dagui toolbox, while still functional, causes lags in game. I had the same experience, even when I unsubscribed from the toolbox mod and starting new saves.

By doing some (really quick) searches online, I found the official [FAQ](https://steamcommunity.com/app/1468810/discussions/0/4637114181344155871/) on steam fourm, and within, it describes a potential solution to frame drops: check the registry.

> 除了已经修复的卡顿外，还有一种卡顿是可能是由于更新导致某些MOD不兼容报错，并向注册表写入了大量错误数据，导致游戏启动缓慢，游戏过程卡顿 [^1]

I also found this in the comment section of the toolbox mod workshop page by [Null](https://steamcommunity.com/id/Null-sys):

> 目前版本使用搜索功能后会向注册表中添加大量乱码项，会导致游戏变得卡顿 [^2]

Following those threads, I checked my registry and found a lot of entries (>56k entries). Looking into those entry, I found that those are not actually error entries, but cache of Names and their Pinyin (probably used by search)!

For example:
```
三品补气丹_pinyin_h4063732890
```
has the value of
```
hex:73,61,6e,70,69,6e,62,75,71,69,64,61,6e,00
```
which is ``sanpinbuqidan``, the Pinyin of the item. Deleting those entries solved the lagging problem (55fps to 190fps).

To add to this problem, I also found entries for NPCs that I remember from saves that I have deleted years ago, meaning that the more saves you have, the worse the problem will be.

## ...So Just deleting it will work?

Yes and no. Everytime you open the list to search (names, items, or anything else) in the toolbox, **ALL** Pinyin and Pinyin initials will be generated by the mod for **ALL** entries. If you have multiple saves that used this mod, those NPCS from other saves will also be saved in the registry (without cleanups)

So, deleting it once will not work: you will have to delete it *every time** you used the search functions (or exit game) to prevent lags.

This mod attempts to automate this process.

## Analysing the Problem

Looking at the entries name, we see that all entries follow the pattern:

```
XXX_pinyin_h##########
```
or
```
XXX_py_h##########
```

Those of you that are familiar with unity might recognize this pattern and storage location as PlayerPrefs used by unity. It seems that the mod is dumping caches into PlayerPrefs, without implementing safety to remove thoes entries.

## Solving the problem (The ranty part)

There are some ways to solve this problem. The best way will definitely be modifying the toolbox code itself to remove the caching functionality, as storing search cache is not one of the intended use of PlayerPrefs (At least as far as I was aware).

However, I do not have access to the source code of the toolbox, as it is not open-sourced. So the second best way to solve this will be to write another mod to remove the entries afterwards.

This would be simple IF UNITY has a built in way to GET ALL PLAYERPREFS!! Instead, Unity said LOL no, we will only give you methods to read entries IF YOU KNOW THE EXACT NAME. Why unity why.

Seriously, I'm not the only one who wants a proper method of getting all playerprefs, right?

Those of you who know Unity may say that *Well there is a DeleteAll method that can be used, right?* Well the game also stores all its settings in PlayerPrefs so delete all will also reset all settings so thats not gonna work.

So what I had to do is to manually read through the actual registry, instead using a quote unquote safe method provided by Unity. Reading registry in a mod feels so wrong but it has to be done in order for this to be fixed. Unity Pls fix.

Fortunantly, after I got all the entries, I can delete them by keys using built in functions. At least that part is safe.

Yeah, so I made the game delete all the pinyin caches at exit and on game save, and the game should run smoothly now.

[^1]: TRANSLATE: Except the lags that are already fixed, another potential lag can be cause by updates causing some mods to be incompatible, and writting large amount of error data to the registry, causing the game to start slower and lag during gameplay

[^2]: TRANSLATE: Current version after using the search functionality [the mod] will add large amount of error entries to the registry, causing the game to be laggy